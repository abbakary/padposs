{% extends 'tracker/base.html' %}
{% load static %}
{% load humanize %}
{% load date_filters %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>POS Tracker Dashboard</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'tracker:dashboard' %}">
                            <svg class="stroke-icon">
                                <use href="../assets/svg/icon-sprite.svg#stroke-home"></use>
                            </svg>
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

{% if user.is_superuser %}
<div class="container-fluid">
  <div class="card shadow-sm mb-3">
    <div class="card-body py-2">
      <div class="d-flex align-items-center">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#adminBranchFilter" title="Toggle Admin Filters">
          <i class="fa fa-cog"></i>
        </button>
        <small class="text-muted">Admin Controls</small>
        {% if request.GET.branch %}
        <span class="badge bg-info text-dark ms-2">Branch {{ request.GET.branch }}</span>
        {% endif %}
      </div>
      <div class="collapse mt-2" id="adminBranchFilter">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-auto">
            <label class="form-label fw-medium">Branch Filter</label>
            <input type="text" name="branch" value="{{ request.GET.branch }}" class="form-control" placeholder="Branch name" list="branchesList">
            {% include 'tracker/partials/branch_datalist.html' %}
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" type="submit"><i class="fa fa-filter me-1"></i>Apply Filter</button>
          </div>
          {% if request.GET.branch %}
          <div class="col-auto">
            <a href="?" class="btn btn-outline-secondary"><i class="fa fa-times me-1"></i>Clear</a>
          </div>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Container-fluid starts -->
<div class="container-fluid">
    <!-- First Row: Key Performance Indicators -->
    <div class="row">
        <!-- Total Customers -->
        <div class="col-xxl-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="dashboard-icon bg-success-light">
                            <i data-feather="users"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-1">TOTAL CUSTOMERS</h6>
                            <h3 class="f-w-600 mb-0">{{ total_customers|default:0 }}</h3>
                            <p class="mb-0 text-muted">{{ new_customers_this_month|default:0 }} new this month</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Orders -->
        <div class="col-xxl-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="dashboard-icon bg-warning-light">
                            <i data-feather="shopping-bag"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-1">TOTAL ORDERS</h6>
                            <h3 class="f-w-600 mb-0">{{ total_orders|default:0 }}</h3>
                            <p class="mb-0 text-muted">{{ completed_orders|default:0 }} completed ({{ completion_rate|floatformat:0 }}%)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Today -->
        <div class="col-xxl-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="dashboard-icon bg-info-light">
                            <i data-feather="check-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-1">Completed Today</h6>
                            <h3 class="f-w-600 mb-0">{{ completed_today|default:0 }}</h3>
                            <p class="mb-0 text-muted">as of {{ current_time|date:"H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress Orders -->
        <div class="col-xxl-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="dashboard-icon bg-primary-light">
                            <i data-feather="clock"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-1">In Progress</h6>
                            <h3 class="f-w-600 mb-0">{{ status_counts.in_progress|default:0 }}</h3>
                            <p class="mb-0 text-muted">active orders</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row: Charts -->
    <div class="row mt-4">
        <!-- Service Distribution -->
        <div class="col-xxl-6 col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Service Distribution</h5>
                </div>
                <div class="card-body">
                   
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'tracker:analytics_service' %}" class="btn btn-sm btn-outline-primary">View Details</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status -->
        <div class="col-xxl-6 col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Order Status</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="orderStatusChart" width="400" height="300"></canvas>
                    </div>
                    <div class="status-legend mt-3">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #28a745;"></div>
                                    <small>Completed</small>
                                    <div class="fw-bold">{{ status_counts.completed|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #007bff;"></div>
                                    <small>In Progress</small>
                                    <div class="fw-bold">{{ status_counts.in_progress|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #dc3545;"></div>
                                    <small>Overdue</small>
                                    <div class="fw-bold">{{ status_counts.overdue|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #6c757d;"></div>
                                    <small>Cancelled</small>
                                    <div class="fw-bold">{{ status_counts.cancelled|default:0 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Third Row: Top Customers -->
    <div class="col-12 mt-4">
        <div class="card h-100">
            <div class="card-header card-no-border">
                <h4>Top Customers by Orders</h4>
                <div class="d-flex align-items-center gap-2">
                    <span class="update-data d-none d-md-block f-light">Top customers by order volume</span>
                    <a href="{% url 'tracker:customers_list' %}?sort=-order_count" class="ms-auto btn btn-outline-primary btn-sm">
                        View All <i class="fa fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-borderless">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">#</th>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Total Orders</th>
                                <th>Last Order</th>
                                <th>Registration Date</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in top_customers %}
                            <tr class="border-bottom">
                                <td class="ps-4 fw-600">{{ forloop.counter }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-2">
                                            <div class="avatar-initial bg-soft-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <span class="text-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} fw-600">
                                                    {{ customer.full_name|slice:":1"|upper }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="fw-600">{{ customer.full_name|default:'Unknown' }}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        {% if customer.phone %}
                                        <a href="tel:{{ customer.phone }}" class="text-muted small">{{ customer.phone }}</a>
                                        {% endif %}
                                        {% if customer.email %}
                                        <a href="mailto:{{ customer.email }}" class="text-muted small text-truncate" style="max-width: 150px;" title="{{ customer.email }}">
                                            {{ customer.email }}
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="fw-600">{{ customer.order_count }} order{{ customer.order_count|pluralize }}</td>
                                <td>
                                    {% if customer.latest_order_date %}
                                    <span class="fw-600">{{ customer.latest_order_date|date:"Y-m-d" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="fw-600">{{ customer.registration_date|date:"Y-m-d" }}</span>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="d-flex justify-content-end gap-2">
                                        {% if customer.id %}
                                        <a href="{% url 'tracker:customer_detail' customer.id %}" class="btn btn-outline-primary btn-sm px-2">View</a>
                                        <a href="{% url 'tracker:create_order_for_customer' customer.id %}" class="btn btn-outline-success btn-sm px-2">New Order</a>
                                        {% else %}
                                        <span class="text-muted small">No actions available</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="d-flex flex-column align-items-center">
                                        <i class="fa fa-users fa-2x text-muted mb-2"></i>
                                        <span class="text-muted">No customer data available</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Fourth Row: Recent Orders -->
    <div class="col-12 mt-4">
        <div class="card h-100">
            <div class="card-header card-no-border">
                <h4>Recent Orders</h4>
                <div class="d-flex align-items-center gap-2">
                    <span class="update-data d-none d-md-block f-light">Latest 10 orders</span>
                    <a href="{% url 'tracker:orders_list' %}" class="ms-auto btn btn-outline-primary btn-sm">
                        View All <i class="fa fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive custom-scrollbar" style="max-height: 400px;">
                    <table class="table table-hover table-borderless">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Order #</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr class="border-bottom">
                                <td class="ps-4">
                                    <a href="{% url 'tracker:order_detail' order.id %}" class="text-primary fw-600">#{{ order.order_number }}</a>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-2">
                                            <div class="avatar-initial bg-soft-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <span class="text-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} fw-600">
                                                    {{ order.customer.full_name|default:'W'|slice:":1"|upper }}
                                                </span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="fw-600">{{ order.customer.full_name|default:'Walk-in Customer' }}</div>
                                            <div class="small text-muted">{{ order.customer.phone|default:'' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-soft-{% if order.type == 'sales' %}primary{% elif order.type == 'service' %}success{% else %}secondary{% endif %} text-{% if order.type == 'sales' %}primary{% elif order.type == 'service' %}success{% else %}secondary{% endif %}">
                                        <i class="fa fa-{% if order.type == 'sales' %}shopping-cart{% elif order.type == 'service' %}tools{% else %}question-circle{% endif %} me-1"></i>
                                        {{ order.get_type_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-soft-{% if order.status == 'completed' %}success{% elif order.status == 'in_progress' %}warning{% elif order.status == 'created' %}info{% elif order.status == 'overdue' %}danger{% else %}secondary{% endif %} text-{% if order.status == 'completed' %}success{% elif order.status == 'in_progress' %}warning{% elif order.status == 'created' %}info{% elif order.status == 'overdue' %}danger{% else %}secondary{% endif %} p-2">
                                        <i class="fa fa-{% if order.status == 'completed' %}check-circle{% elif order.status == 'in_progress' %}spinner fa-spin{% elif order.status == 'created' %}clock{% elif order.status == 'overdue' %}exclamation-triangle{% else %}ellipsis-h{% endif %} me-1"></i>
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="d-flex flex-column">
                                        <span class="fw-600">{{ order.created_at|date:"Y-m-d H:i" }}</span>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="d-flex flex-column align-items-center">
                                        <i class="fa fa-inbox fa-2x text-muted mb-2"></i>
                                        <span class="text-muted">No recent orders found</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Container-fluid Ends -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard_charts.js' %}"></script>
<script>
(function(){
  function drawPie(canvas, data, colors) {
    var ctx = canvas.getContext('2d');
    var total = data.values.reduce(function(a,b){return a+b;},0) || 1;
    var cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx, cy) - 10;
    var start = -Math.PI/2;
    for (var i=0;i<data.values.length;i++){
      var slice = (data.values[i]/total) * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+slice);
      ctx.closePath();
      ctx.fillStyle = colors[i%colors.length];
      ctx.fill();
      start += slice;
    }
  }
  function drawDonut(canvas, data, colors) {
    drawPie(canvas, data, colors);
    var ctx = canvas.getContext('2d');
    var cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx, cy) - 10;
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(cx, cy, r*0.55, 0, Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation = 'source-over';
  }
  document.addEventListener('DOMContentLoaded', function(){
    // Progress bars init (existing)
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar){
      var width = bar.dataset.width;
      bar.style.width = width + '%';
      bar.setAttribute('aria-valuenow', width);
    });
    // Service distribution pie from type_counts
    try{
      var svcCanvas = document.getElementById('serviceDistributionCanvas');
      if (svcCanvas) {
        var data = {
          labels: ['Sales','Service','Inquiry'],
          values: [
            {{ type_counts.sales|default:0 }},
            {{ type_counts.service|default:0 }},
            {{ type_counts.inquiry|default:0 }}
          ]
        };
        var colors = ['#4e79a7','#59a14f','#f28e2b'];
        drawPie(svcCanvas, data, colors);
      }
    }catch(e){}
    // Order status donut from status_counts
    try{
      var statusCanvas = document.getElementById('orderStatusCanvas');
      if (statusCanvas) {
        var data2 = {
          labels: ['In Progress','Overdue','Completed','Cancelled'],
          values: [
            {{ status_counts.in_progress|default:0 }},
            {{ status_counts.overdue|default:0 }},
            {{ status_counts.completed|default:0 }},
            {{ status_counts.cancelled|default:0 }}
          ]
        };
        var colors2 = ['#60a5fa','#f59e0b','#ef4444','#22c55e','#94a3b8'];
        drawDonut(statusCanvas, data2, colors2);
      }
    }catch(e){}
  });
})();
</script>
{% endblock %}
